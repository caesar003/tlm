#!/bin/bash

# Tmux Layout Manager - Main Entry Point

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine the correct library path based on installation type
if [[ -f "$SCRIPT_DIR/lib/config.sh" ]]; then
    # Development mode - libraries are in lib/ subdirectory
    LIB_DIR="$SCRIPT_DIR/lib"
elif [[ -f "/usr/lib/tlm/config.sh" ]]; then
    # System installation - libraries are in /usr/lib/tlm/
    LIB_DIR="/usr/lib/tlm"
else
    echo "Error: Cannot find tlm library files" >&2
    echo "Looked in:" >&2
    echo "  $SCRIPT_DIR/lib/" >&2
    echo "  /usr/lib/tlm/" >&2
    exit 1
fi

# Source required modules
source "$LIB_DIR/config.sh"
source "$LIB_DIR/core.sh"

# Display version information
print_version() {
	echo "Tmux Layout Manager version $TLM_VERSION"
}

# Display help information
show_help() {
	echo "$HELP_USAGE"
	echo ""
	echo "$HELP_OPTIONS"
	echo ""
	echo "$HELP_EXAMPLES"
	echo ""
	echo "$HELP_SESSION_NAMING"
	echo ""
	echo "$HELP_CONFIG_INFO"
}

# Parse command line arguments and execute appropriate action
parse_arguments() {
	if [[ "$#" -eq 0 ]]; then
		show_help
		exit $EXIT_SUCCESS
	fi

	while [[ "$#" -gt 0 ]]; do
		case "$1" in
		-i | --init)
			local layout_name="$2"
			local custom_session_name=""
			
			# Skip if next argument is a flag
			if [[ "$layout_name" == -* ]]; then
				layout_name=""
			else
				shift
				# Check if next argument is a session name (not a flag)
				if [[ -n "$1" && "$1" != -* ]]; then
					custom_session_name="$1"
					shift
				fi
			fi
			
			load "$layout_name" "$custom_session_name"
			exit $?
			;;
		-l | --list)
			list_layouts
			exit $EXIT_SUCCESS
			;;
		-v | --version)
			print_version
			exit $EXIT_SUCCESS
			;;
		-d | --detail)
			local layout_name="$2"
			# Skip if next argument is a flag or empty
			if [[ "$layout_name" == -* || -z "$layout_name" ]]; then
				layout_name=""
			else
				shift
			fi
			show_layout_details "$layout_name"
			exit $?
			;;
		-h | --help)
			show_help
			exit $EXIT_SUCCESS
			;;
		*)
			echo "Unknown option: $1" >&2
			show_help >&2
			exit $EXIT_ERROR
			;;
		esac
		shift
	done
}

# Main execution
main() {
	parse_arguments "$@"
}

# Execute main function with all arguments
main "$@"
